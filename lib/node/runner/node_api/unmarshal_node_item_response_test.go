package api

import (
	"bufio"
	"strings"
	"testing"

	"github.com/stretchr/testify/require"
)

func TestUnmarshalNodeItemResponse(t *testing.T) {
	input := "ballot {\"H\":{\"version\":\"1\",\"hash\":\"QPBbbmbpwJvUcXGtZ6e8N4e95VrPmXZdoDwhRQLhAy5\",\"signature\":\"3keZsoWCzwE5F5qxuXH1rB34MovZGm5mFcfLBx4n3pWEgoTNx9ihQ353MPhHsikMTwKiWsFyYryBkEWtJByzvc6g\",\"proposer_signature\":\"3E4bgsXCmjsp8gE1A1RTiAbAgXuvb9jv893rVEdrotWZunWHXPA25BMSq6Go2wcF5r7Hm1MzVavq2yqfqjKqVPu6\"},\"B\":{\"confirmed\":\"2019-01-02T18:04:50.568815000+09:00\",\"proposed\":{\"confirmed\":\"2019-01-02T18:04:50.568619000+09:00\",\"proposer\":\"GAYGELM74WJMKSLDN5YP2VAMP64WC4IXIGICUNK2SCVIT7KPTLY7M3MW\",\"voting_basis\":{\"round\":1,\"height\":3,\"block-hash\":\"Ebw2UiWg8dQVqdaSm3SJmUxfkp6tCYtsqis5xpBJZv4W\",\"total-txs\":3,\"total-ops\":6},\"transactions\":null,\"proposer_transaction\":{\"H\":{\"version\":\"1\",\"created\":\"2019-01-02T18:04:50.568218000+09:00\",\"signature\":\"46rhBWSNEGLKaHNwxwnEPftk7PhDobHe3s9GSBAqkFiSHCAyxSvLtTwYKivPt8eVToh5JfxieHmk7GDWb8jUQiXu\"},\"B\":{\"source\":\"GAYGELM74WJMKSLDN5YP2VAMP64WC4IXIGICUNK2SCVIT7KPTLY7M3MW\",\"fee\":\"0\",\"sequence_id\":0,\"operations\":[{\"H\":{\"type\":\"collect-tx-fee\"},\"B\":{\"target\":\"GDYIHSHMDXJ4MXE35N4IMNC2X3Q3F665C5EX2JWHHCUW2PCFVXIFEE2C\",\"amount\":\"0\",\"txs\":0,\"block-height\":3,\"block-hash\":\"Ebw2UiWg8dQVqdaSm3SJmUxfkp6tCYtsqis5xpBJZv4W\",\"total-txs\":3,\"total-ops\":0}},{\"H\":{\"type\":\"inflation\"},\"B\":{\"target\":\"GDYIHSHMDXJ4MXE35N4IMNC2X3Q3F665C5EX2JWHHCUW2PCFVXIFEE2C\",\"amount\":\"500000000\",\"initial_balance\":\"5000000000000000\",\"ratio\":\"0.00000010000000000\",\"block-height\":3,\"block-hash\":\"Ebw2UiWg8dQVqdaSm3SJmUxfkp6tCYtsqis5xpBJZv4W\",\"total-txs\":3,\"total-ops\":0}}]}}},\"source\":\"GAYGELM74WJMKSLDN5YP2VAMP64WC4IXIGICUNK2SCVIT7KPTLY7M3MW\",\"state\":1,\"vote\":\"YES\",\"reason\":null}}\nballot {\"H\":{\"version\":\"1\",\"hash\":\"8Mb8MHacZNRfNafcKCQJzGqV7NSCr5NxkqkSZMct5WWk\",\"signature\":\"2CaFHcDjHbYsamXsxNbHuFTg3epnmwHk1yqwYB7sBCLKijvpuV6H8aNmzRGPj5damRiwhcVQXytAWFSVrTKrFLDj\",\"proposer_signature\":\"3E4bgsXCmjsp8gE1A1RTiAbAgXuvb9jv893rVEdrotWZunWHXPA25BMSq6Go2wcF5r7Hm1MzVavq2yqfqjKqVPu6\"},\"B\":{\"confirmed\":\"2019-01-02T18:04:50.570395000+09:00\",\"proposed\":{\"confirmed\":\"2019-01-02T18:04:50.568619000+09:00\",\"proposer\":\"GAYGELM74WJMKSLDN5YP2VAMP64WC4IXIGICUNK2SCVIT7KPTLY7M3MW\",\"voting_basis\":{\"round\":1,\"height\":3,\"block-hash\":\"Ebw2UiWg8dQVqdaSm3SJmUxfkp6tCYtsqis5xpBJZv4W\",\"total-txs\":3,\"total-ops\":6},\"transactions\":null,\"proposer_transaction\":{\"H\":{\"version\":\"1\",\"created\":\"2019-01-02T18:04:50.568218000+09:00\",\"signature\":\"46rhBWSNEGLKaHNwxwnEPftk7PhDobHe3s9GSBAqkFiSHCAyxSvLtTwYKivPt8eVToh5JfxieHmk7GDWb8jUQiXu\"},\"B\":{\"source\":\"GAYGELM74WJMKSLDN5YP2VAMP64WC4IXIGICUNK2SCVIT7KPTLY7M3MW\",\"fee\":\"0\",\"sequence_id\":0,\"operations\":[{\"H\":{\"type\":\"collect-tx-fee\"},\"B\":{\"target\":\"GDYIHSHMDXJ4MXE35N4IMNC2X3Q3F665C5EX2JWHHCUW2PCFVXIFEE2C\",\"amount\":\"0\",\"txs\":0,\"block-height\":3,\"block-hash\":\"Ebw2UiWg8dQVqdaSm3SJmUxfkp6tCYtsqis5xpBJZv4W\",\"total-txs\":3,\"total-ops\":0}},{\"H\":{\"type\":\"inflation\"},\"B\":{\"target\":\"GDYIHSHMDXJ4MXE35N4IMNC2X3Q3F665C5EX2JWHHCUW2PCFVXIFEE2C\",\"amount\":\"500000000\",\"initial_balance\":\"5000000000000000\",\"ratio\":\"0.00000010000000000\",\"block-height\":3,\"block-hash\":\"Ebw2UiWg8dQVqdaSm3SJmUxfkp6tCYtsqis5xpBJZv4W\",\"total-txs\":3,\"total-ops\":0}}]}}},\"source\":\"GAYGELM74WJMKSLDN5YP2VAMP64WC4IXIGICUNK2SCVIT7KPTLY7M3MW\",\"state\":2,\"vote\":\"YES\",\"reason\":null}}\nballot {\"H\":{\"version\":\"1\",\"hash\":\"65iBCwS3Pern3qS7jF59PDNrSVFzDJutKKsSWQUK3KEm\",\"signature\":\"4bwnYmLALHrfDwQc7Ps7kYzDAgAhGgzskJZ2kiAbNByRajH4b88AXs3zk9Thv4ndCQn4J2oUSdq4E9X3mY97H6au\",\"proposer_signature\":\"3E4bgsXCmjsp8gE1A1RTiAbAgXuvb9jv893rVEdrotWZunWHXPA25BMSq6Go2wcF5r7Hm1MzVavq2yqfqjKqVPu6\"},\"B\":{\"confirmed\":\"2019-01-02T18:04:50.571183000+09:00\",\"proposed\":{\"confirmed\":\"2019-01-02T18:04:50.568619000+09:00\",\"proposer\":\"GAYGELM74WJMKSLDN5YP2VAMP64WC4IXIGICUNK2SCVIT7KPTLY7M3MW\",\"voting_basis\":{\"round\":1,\"height\":3,\"block-hash\":\"Ebw2UiWg8dQVqdaSm3SJmUxfkp6tCYtsqis5xpBJZv4W\",\"total-txs\":3,\"total-ops\":6},\"transactions\":null,\"proposer_transaction\":{\"H\":{\"version\":\"1\",\"created\":\"2019-01-02T18:04:50.568218000+09:00\",\"signature\":\"46rhBWSNEGLKaHNwxwnEPftk7PhDobHe3s9GSBAqkFiSHCAyxSvLtTwYKivPt8eVToh5JfxieHmk7GDWb8jUQiXu\"},\"B\":{\"source\":\"GAYGELM74WJMKSLDN5YP2VAMP64WC4IXIGICUNK2SCVIT7KPTLY7M3MW\",\"fee\":\"0\",\"sequence_id\":0,\"operations\":[{\"H\":{\"type\":\"collect-tx-fee\"},\"B\":{\"target\":\"GDYIHSHMDXJ4MXE35N4IMNC2X3Q3F665C5EX2JWHHCUW2PCFVXIFEE2C\",\"amount\":\"0\",\"txs\":0,\"block-height\":3,\"block-hash\":\"Ebw2UiWg8dQVqdaSm3SJmUxfkp6tCYtsqis5xpBJZv4W\",\"total-txs\":3,\"total-ops\":0}},{\"H\":{\"type\":\"inflation\"},\"B\":{\"target\":\"GDYIHSHMDXJ4MXE35N4IMNC2X3Q3F665C5EX2JWHHCUW2PCFVXIFEE2C\",\"amount\":\"500000000\",\"initial_balance\":\"5000000000000000\",\"ratio\":\"0.00000010000000000\",\"block-height\":3,\"block-hash\":\"Ebw2UiWg8dQVqdaSm3SJmUxfkp6tCYtsqis5xpBJZv4W\",\"total-txs\":3,\"total-ops\":0}}]}}},\"source\":\"GDIRF4UWPACXPPI4GW7CMTACTCNDIKJEHZK44RITZB4TD3YUM6CCVNGJ\",\"state\":2,\"vote\":\"YES\",\"reason\":null}}\n"
	sc := bufio.NewScanner(strings.NewReader(input))
	var ballots []interface{}
	for sc.Scan() {
		var itemType NodeItemDataType
		var b interface{}
		var err error
		itemType, b, err = UnmarshalNodeItemResponse(sc.Bytes())
		require.NoError(t, err)
		require.Equal(t, NodeItemBallot, itemType)
		ballots = append(ballots, b)
	}
	require.Equal(t, 3, len(ballots))
}
